<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sobres - Óptica Optalvis</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- jQuery UI CSS para autocompletado -->
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <link rel="stylesheet" href="/static/styles_receta.css">
</head>
<body>
    <header class="main-header">
        <div class="logo">
            <h3>Óptica Optalvis</h3>
        </div>
        <h3>Registro de Recetas</h3>
        <nav class="main-nav">
            <ul>
                <li><a href="/">Inicio</a></li>
                <li><a href="#">Productos</a></li>
                <li><a href="#">Servicios</a></li>
                <li><a href="#">Contactos</a></li>
                <li><a href="/importar">Importar Datos</a></li>
                <li><a href="/estadisticas">Estadísticas</a></li>                
            </ul>
        </nav>
    </header>
    <div class="contenedor">
        <!-- Toast para mensajes de error -->
        <div class="toast-container position-fixed top-0 end-0 p-3">
            <div id="errorToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header">
                    <strong class="me-auto">Error</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body" id="errorToastBody"></div>
            </div>
        </div>

        <form id="registroRecetasForm" method="POST" action="/registrar_receta" enctype="application/x-www-form-urlencoded">
            <fieldset>
                <legend>Datos Cliente</legend>
                <div class="field-group">
                    <label for="numeroReceta">Nº Receta:</label>
                    <input type="text" class="form-control" id="numeroReceta" name="numero_receta" required>
                </div>
                <div class="field-group">
                    <label for="nombresCliente">Nombres:</label>
                    <input type="text" class="form-control" id="nombresCliente" name="nombres_cliente" required>
                </div>
                <div class="field-group">
                    <label for="apePaterno">Ap. Paterno:</label>
                    <input type="text" class="form-control" id="apePaterno" name="apellido_paterno">
                </div>
                <div class="field-group">
                    <label for="apeMaterno">Ap. Materno:</label>
                    <input type="text" class="form-control" id="apeMaterno" name="apellido_materno">
                </div>
            </fieldset>
            
            <fieldset>
                <div class="field-group">
                    <label for="telDireccion">Tel. / Dirección:</label>
                    <input type="text" class="form-control" id="telDireccion" name="telefono_direccion">
                </div>
                <div class="field-group">
                    <label for="fechaReceta">Fecha Receta:</label>
                    <input type="date" class="form-control" id="fechaReceta" name="fecha_receta">
                </div>
                <div class="field-group">
                    <label for="doctorReceta">Doctor:</label>
                    <input type="text" class="form-control" id="doctorReceta" name="doctor_receta" value="" autocomplete="off">
                </div>
                <div class="field-group">
                    <label for="tiendaOptica">Tienda:</label>
                    <input type="text" class="form-control" id="tiendaOptica" name="tienda_optica" value="" autocomplete="off">
                </div>
                <div class="field-group">
                    <label for="procedenciaCliente">Procedencia:</label>
                    <input type="text" class="form-control" id="procedenciaCliente" name="procedencia_cliente" value="" autocomplete="off">
                </div>
            </fieldset>

            <!-- Grupo izquierdo -->
            <div class="form-group">
                <legend>LEJOS</legend>
                <!-- Fila superior del grupo izquierdo -->
                <div class="form-row">
                    <div class="form-field">
                        <label for="esf_lejos_od">Esférico OD:</label>
                        <input type="text" id="esf_lejos_od" name="esf_lejos_od">
                    </div>
                    <div class="form-field">
                        <label for="cil_lejos_od">Cilindro OD:</label>
                        <input type="text" id="cil_lejos_od" name="cil_lejos_od">
                    </div>
                    <div class="form-field">
                        <label for="eje_lejos_od">Ejeº OD:</label>
                        <input type="text" id="eje_lejos_od" name="eje_lejos_od">
                    </div>
                </div>
                
                <!-- Fila inferior del grupo izquierdo -->
                <div class="form-row">
                    <div class="form-field">
                        <label for="esf_lejos_oi">Esférico OI:</label>
                        <input type="text" id="esf_lejos_oi" name="esf_lejos_oi">
                    </div>
                    <div class="form-field">
                        <label for="cil_lejos_oi">Cilindro OI:</label>
                        <input type="text" id="cil_lejos_oi" name="cil_lejos_oi">
                    </div>
                    <div class="form-field">
                        <label for="eje_lejos_oi">Ejeº OI:</label>
                        <input type="text" id="eje_lejos_oi" name="eje_lejos_oi">
                    </div>
                </div>
            </div>

            <!-- Grupo derecho -->
            <div class="form-group">
                <legend>CERCA</legend>
                <!-- Fila superior del grupo derecho -->
                <div class="form-row">
                    <div class="form-field">
                        <label for="esf_cerca_od">Esferico OD:</label>
                        <input type="text" id="esf_cerca_od" name="esf_cerca_od">
                    </div>
                    <div class="form-field">
                        <label for="cil_cerca_od">Cilindro OD:</label>
                        <input type="text" id="cil_cerca_od" name="cil_cerca_od">
                    </div>
                    <div class="form-field">
                        <label for="eje_cerca_od">Ejeº OD:</label>
                        <input type="text" id="eje_cerca_od" name="eje_cerca_od">
                    </div>
                </div>
                
                <!-- Fila inferior del grupo derecho -->
                <div class="form-row">
                    <div class="form-field">
                        <label for="esf_cerca_oi">Esférico OI:</label>
                        <input type="text" id="esf_cerca_oi" name="esf_cerca_oi">
                    </div>
                    <div class="form-field">
                        <label for="cil_cerca_oi">Cilindro OI:</label>
                        <input type="text" id="cil_cerca_oi" name="cil_cerca_oi">
                    </div>
                    <div class="form-field">
                        <label for="eje_cerca_oi">Ejeº OI:</label>
                        <input type="text" id="eje_cerca_oi" name="eje_cerca_oi">
                    </div>
                </div>
            </div>

            <fieldset>
                <div class="field-group">
                    <label for="dip_lejos">DIP LEJOS:</label>
                    <input type="text" class="form-control" id="dip_lejos" name="dip_lejos">
                </div>
                <div class="field-group">
                    <label for="dip_cerca">DIP CERCA:</label>
                    <input type="text" class="form-control" id="dip_cerca" name="dip_cerca">
                </div>
                <div class="field-group">
                    <label for="dip_od">DIP OD:</label>
                    <input type="text" class="form-control" id="dip_od" name="dip_od">
                </div>
                <div class="field-group">
                    <label for="dip_oi">DIP OI:</label>
                    <input type="text" class="form-control" id="dip_oi" name="dip_oi">
                </div>
                <div class="field-group">
                    <label for="base_lente">BASE:</label>
                    <input type="text" class="form-control" id="base_lente" name="base_lente">
                </div>
            </fieldset>

            <fieldset>
                <div class="field-group wide">
                    <label for="material_cristal_01">Cristales 1:</label>
                    <input type="text" class="form-control" id="material_cristal_01" name="material_cristal_01" autocomplete="off">
                </div>
                <div class="field-group wide">
                    <label for="material_cristal_02">Cristales 2:</label>
                    <input type="text" class="form-control" id="material_cristal_02" name="material_cristal_02" autocomplete="off">
                </div>
            </fieldset>
            
            <fieldset>
                <div class="field-group">
                    <label for="proveedorOptica">Proveedor:</label>
                    <input type="text" class="form-control" id="proveedorOptica" name="proveedor_optica" value="" autocomplete="off">
                </div>
                <div class="field-group">
                    <label for="armadorOptica">Armador:</label>
                    <input type="text" class="form-control" id="armadorOptica" name="armador_optica" value="" autocomplete="off">
                </div>
                <div class="field-group">
                    <label for="alturaLente">Altura:</label>
                    <input type="text" class="form-control" id="alturaLente" name="altura_lente">
                </div>
                <div class="field-group">
                    <label for="armazonLente">Armazón:</label>
                    <input type="text" class="form-control" id="armazonLente" name="armazon_lente" value="" autocomplete="off">
                </div>
            </fieldset>

            
            <fieldset>
                <div class="field-group">
                    <label for="numeroSobre">Número de Sobre:</label>
                    <input type="text" class="form-control" id="numeroSobre" name="numero_sobre">
                </div>
                <div class="field-group">
                    <label for="fechaEntrega">Fecha Entrega:</label>
                    <input type="date" class="form-control" id="fechaEntrega" name="fecha_entrega">
                </div>
                <div class="field-group">
                    <label for="numeroPedido">Número de Boleta / Pedido:</label>
                    <input type="text" class="form-control" id="numeroPedido" name="numero_pedido">
                </div>
            </fieldset>
            
            <div class="buttons-section">
                <button type="submit" class="btn btn-success btn-registrar">REGISTRAR RECETA</button>
                <div class="btn-group">
                    <a href="/registros-recetas" class="btn btn-warning">VER REGISTROS DE RECETAS</a>
                    <a href="/buscar" class="btn btn-warning">BUSCAR RECETAS</a>
                </div>
            </div>
        </form>

        <!-- Modal de Bootstrap -->
        <div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="successModalLabel">¡Éxito!</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        Receta registrada exitosamente.
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-success" id="modalAccept" data-bs-dismiss="modal">Aceptar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- jQuery y jQuery UI para autocompletado -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <!-- Bootstrap JS y Popper.js -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"></script>
    <script>
        $(document).ready(function() {
            // Configurar autocompletado para el campo doctor
            $("#doctorReceta").autocomplete({
                source: async function(request, response) {
                    try {
                        const res = await fetch(`/api/doctores?query=${request.term}`);
                        const data = await res.json();
                        response(data);
                    } catch (error) {
                        console.error("Error al obtener doctores:", error);
                        response([]);
                    }
                },
                minLength: 1
            });

            // Configurar autocompletado para el campo tienda
            $("#tiendaOptica").autocomplete({
                source: async function(request, response) {
                    try {
                        const res = await fetch(`/api/tiendas?query=${request.term}`);
                        const data = await res.json();
                        response(data);
                    } catch (error) {
                        console.error("Error al obtener tiendas:", error);
                        response([]);
                    }
                },
                minLength: 1
            });

            // Configurar autocompletado para el campo proveedor
            $("#proveedorOptica").autocomplete({
                source: async function(request, response) {
                    try {
                        const res = await fetch(`/api/proveedores?query=${request.term}`);
                        const data = await res.json();
                        response(data);
                    } catch (error) {
                        console.error("Error al obtener proveedores:", error);
                        response([]);
                    }
                },
                minLength: 1
            });

            // Corregido ID del autocomplete para armazón
            $("#armazonLente").autocomplete({
                source: async function(request, response) {
                    try {
                        const res = await fetch(`/api/armazones?query=${request.term}`);
                        const data = await res.json();
                        response(data);
                    } catch (error) {
                        console.error("Error al obtener armazones:", error);
                        response([]);
                    }
                },
                minLength: 1
            });

            // Corregido ID para procedencia
            $("#procedenciaCliente").autocomplete({
                source: async function(request, response) {
                    try {
                        const res = await fetch(`/api/procedencias?query=${request.term}`);
                        const data = await res.json();
                        response(data);
                    } catch (error) {
                        console.error("Error al obtener procedencias:", error);
                        response([]);
                    }
                },
                minLength: 1
            });

            // Configurar autocompletado para el campo armador
            $("#armadorOptica").autocomplete({
                source: async function(request, response) {
                    try {
                        const res = await fetch(`/api/armadores?query=${request.term}`);
                        const data = await res.json();
                        response(data);
                    } catch (error) {
                        console.error("Error al obtener armadores:", error);
                        response([]);
                    }
                },
                minLength: 1
            });

            // Configurar autocompletado para el campo cristales 1
            $("#material_cristal_01").autocomplete({
                source: async function(request, response) {
                    try {
                        const res = await fetch(`/api/cristales?query=${request.term}`);
                        const data = await res.json();
                     response(data);
                    } catch (error) {
                        console.error("Error al obtener cristales:", error);
                        response([]);
                    }
                },
            minLength: 1
            });

            // Autocompletado para material_cristal_02
            $("#material_cristal_02").autocomplete({
            source: async function(request, response) {
                try {
                    const res = await fetch(`/api/cristales?query=${request.term}`);
                    const data = await res.json();
                    response(data);
                } catch (error) {
                    console.error("Error al obtener cristales:", error);
                    response([]);
                }
            },
            minLength: 1
            });
        });

    document.getElementById("registroRecetasForm").addEventListener("submit", async function(event) {
    event.preventDefault();
    const form = this;
    const formData = new FormData(form);

    try {
        const response = await fetch("/registrar_receta", {
            method: "POST",
            body: formData
        });

        const result = await response.json();

        if (response.ok && result.message === "Receta registrada exitosamente") {
            const modal = new bootstrap.Modal(document.getElementById("successModal"));
            modal.show();
            document.getElementById("modalAccept").addEventListener("click", function() {
                form.reset();
            });
        } else {
            const toast = new bootstrap.Toast(document.getElementById("errorToast"));
            document.getElementById("errorToastBody").textContent = result.detail || "Error desconocido";
            toast.show();
        }
    } catch (error) {
        const toast = new bootstrap.Toast(document.getElementById("errorToast"));
        document.getElementById("errorToastBody").textContent = "Error en la solicitud: " + error.message;
        toast.show();
    }
});

    </script>
</body>
</html>